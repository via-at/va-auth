<dom-module id="va-auth">
  
  <template>
    
    <firebase-auth id="auth"></firebase-auth>
    
    <va-cordova-oauth id="cordovaAuth"></va-cordova-oauth>
    
  </template>
  
  <script>
    Polymer({
        
      is: 'va-auth',
      
      properties: {
        account: {
        notify: true
        }
      },
      
      attached: function () {
        this.$.auth.auth.onAuthStateChanged(this._onAuthStateChanged.bind(this));
      },
      
      signOut: function () {
        this.$.auth.auth.signOut();
      },
      
      signIn: function (email, password) {
        return this.$.auth.signInWithEmailAndPassword(email, password);
      },
      
      signUp: function (email, password) {
        return this.$.auth.createUserWithEmailAndPassword(email, password);
      },
      
      link: function (e) {
        var promise;
        var provider = e.detail.provider;

        if (window.cordova) {
          var url = this.resolveUrl('../va-cordova-oauth/va-cordova-oauth.html', null, null, true);
          promise = Promise.resolve();

          this.importHref(url, function () {
            this.$.cordovaAuth.signIn(provider).then(function () {
              var credential;

              switch (provider) {
                case 'google':
                  credential = firebase.auth.GoogleAuthProvider.credential(arguments[0], null);
                  break;
                case 'facebook':
                  credential = firebase.auth.FacebookAuthProvider.credential(arguments[0]);
                  break;
                case 'twitter':
                  credential = firebase.auth.TwitterAuthProvider.credential(arguments[0], arguments[1]);
                  break;
              }

              this.$.auth.signInWithCredential(credential).then(function () {
                promise.resolve();
              });
            }.bind(this));
          }.bind(this));
        } else {
          promise = this.$.auth.signInWithPopup(provider);
        }
        
        return promise;
      },
      
      changeEmail: function (email) {
        return this.$.auth.auth.currentUser.updateEmail(email);
      },
      
      changePassword: function (newPassword) {
        return this.$.auth.auth.currentUser.updatePassword(newPassword);
      },
      
      reauthenticate: function () {
        var promise = new Promise(function (resolve, reject) {
        });
        return promise;
        return this.account.providerData[0].providerId === 'email';
      },
      
      hasEmailAndPasswordAccount: function () {
        return this._findAccountByProvider('email');
      },
      
      hasGoogleAccount: function () {
        return this._findAccountByProvider('google.com');
      },
      
      hasFacebookAccount: function () {
        return this._findAccountByProvider('facebook.com');
      },
      
      hasTwitterAccount: function () {
        return this._findAccountByProvider('twitter.com');
      },
      
      _findAccountByProvider: function (provider) {
        for (var i in this.account.providerData) {
          if (this.account.providerData[i].providerId === provider) {
            return true;
          }
        }
        return false;
      },
      
      _onAuthStateChanged: function (user) {
        if (user) {
          this.account = user;
          this.fire('va-auth-signed-in', user);
        } else {
          this.account = null;
          this.fire('va-auth-signed-out');
        }
      }
      
    });
  </script>
  
</dom-module>