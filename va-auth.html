<dom-module id="va-auth">
  
  <template>
    
    <firebase-auth id="auth"></firebase-auth>
    
    <va-auth-dialog id="dialog"></va-auth-dialog>

    <va-cordova-oauth id="cordovaAuth"></va-cordova-oauth>
    
  </template>
  
  <script>
    Polymer({
        
      is: 'va-auth',
      
      listeners: {
        'dialog.auth': '_auth',
        'dialog.signInWithEmail': '_signInWithEmail',
        'dialog.signUpWithEmail': '_signUpWithEmail'
      },
      
      link: function (provider) {
      },
      
      signUp: function () {
        this.$.dialog.openSignUp();
      },
      
      signIn: function (provider, credential) {
        this.$.dialog.openSignIn();
      },
      
      signOut: function () {
        this.$.auth.auth.signOut();
      },
      
      _signInWithEmail: function (e) {
        var promise = this.$.auth.signInWithEmailAndPassword(e.detail.email, e.detail.password);
        promise.then(this._done.bind(this), this._failSignIn.bind(this));
      },
      
      _signUpWithEmail: function (e) {
        var promise = this.$.auth.createUserWithEmailAndPassword(e.detail.email, e.detail.password);
        promise.then(this._done.bind(this), this._failSignUp.bind(this));
      },
      
      _auth: function (e) {
        var provider = e.detail.provider;

        if (window.cordova) {
          var url = this.resolveUrl('../va-cordova-oauth/va-cordova-oauth.html', null, null, true);

          this.importHref(url, function () {
            this.$.cordovaAuth.signIn(provider).then(function () {
              var credential;

              switch (provider) {
                case 'google':
                  credential = firebase.auth.GoogleAuthProvider.credential(arguments[0], null);
                  break;
                case 'facebook':
                  credential = firebase.auth.FacebookAuthProvider.credential(arguments[0]);
                  break;
                case 'twitter':
                  credential = firebase.auth.TwitterAuthProvider.credential(arguments[0], arguments[1]);
                  break;
              }

              this.$.auth.signInWithCredential(credential).then(this._done.bind(this));
            }.bind(this));
          }.bind(this));
        } else {
          this.$.auth.signInWithPopup(provider).then(this._done.bind(this));
        }
      },

      _done: function () {
        this.$.dialog.close();
        this.fire('done');
      },

      _failSignIn: function () {
        this.$.dialog.failSignIn();
        this.fire('error');
      },

      _failSignUp: function () {
        this.$.dialog.failSignUp();
        this.fire('error');
      }
      
    });
  </script>
  
</dom-module>